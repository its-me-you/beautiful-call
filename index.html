<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amour Celestial</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600&family=Parisienne&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --accent: #ff2d75;
            --ethereal: #7000ff;
            --bg: #050508;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: white; height: 100vh; overflow: hidden; }

        /* Celestial Background */
        #nebula { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #050508 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle var(--d) infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* Container */
        .app-window {
            width: 100%; max-width: 450px; height: 100%; margin: 0 auto;
            display: flex; flex-direction: column; position: relative;
            background: rgba(10, 10, 15, 0.4); backdrop-filter: blur(40px);
            border-left: 1px solid var(--glass-border); border-right: 1px solid var(--glass-border);
        }

        .screen { display: none; flex: 1; padding: 40px; flex-direction: column; animation: fadeIn 0.6s ease-out; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* Login Style */
        .logo { font-family: 'Parisienne', cursive; font-size: 4.5rem; color: var(--accent); text-align: center; margin-bottom: 10px; text-shadow: 0 0 30px rgba(255, 45, 117, 0.4); }
        .tagline { text-align: center; opacity: 0.5; font-size: 0.7rem; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 60px; }

        .input-field {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 22px; border-radius: 24px; color: white; font-size: 1.1rem;
            width: 100%; text-align: center; outline: none; margin-bottom: 25px; transition: 0.3s;
        }
        .input-field:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.08); }

        .btn-portal {
            background: linear-gradient(135deg, var(--accent), var(--ethereal));
            color: white; border: none; padding: 22px; border-radius: 24px;
            font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: 0.4s;
            box-shadow: 0 15px 35px rgba(112, 0, 255, 0.3);
        }
        .btn-portal:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        /* List Style */
        .user-scroller { flex: 1; overflow-y: auto; margin-top: 20px; }
        .user-node {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 28px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .avatar-ring { width: 55px; height: 55px; border-radius: 20px; background: linear-gradient(45deg, var(--accent), var(--ethereal)); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.4rem; }
        .call-actions { display: flex; gap: 12px; }
        .btn-action { width: 48px; height: 48px; border-radius: 18px; border: none; background: rgba(255,255,255,0.05); color: white; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: var(--accent); }

        /* Call Stage */
        .call-stage { flex: 1; position: relative; border-radius: 40px; overflow: hidden; background: #000; margin-bottom: 30px; border: 1px solid var(--glass-border); }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; bottom: 20px; right: 20px; width: 110px; height: 150px; border-radius: 20px; border: 2px solid var(--accent); z-index: 10; object-fit: cover; }
        .controls-hub { display: flex; justify-content: center; gap: 25px; padding-bottom: 20px; }
        .btn-ctrl { width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer; color: white; font-size: 1.4rem; background: var(--glass); border: 1px solid var(--glass-border); }
        .btn-hangup { background: var(--accent); box-shadow: 0 10px 20px rgba(255, 45, 117, 0.4); }

        /* Notification */
        #incoming-portal {
            position: fixed; inset: 0; background: rgba(5,5,8,0.95); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

    <div id="nebula"></div>

    <div class="app-window">
        <div id="screen-join" class="screen active">
            <div style="margin-top: auto; margin-bottom: auto;">
                <h1 class="logo">Amour</h1>
                <p class="tagline">Celestial Connection</p>
                <input type="text" id="nameInput" class="input-field" placeholder="Identify your soul...">
                <button id="joinBtn" class="btn-portal" onclick="Logic.handleJoin()">Open Portal</button>
                <p id="debug-info" style="color: var(--accent); font-size: 0.8rem; text-align: center; margin-top: 20px;"></p>
            </div>
        </div>

        <div id="screen-dash" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-weight: 300; letter-spacing: 1px;">Online Souls</h2>
                <div id="userCount" style="background: var(--accent); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;">0</div>
            </div>
            <div id="userList" class="user-scroller"></div>
        </div>

        <div id="screen-call" class="screen">
            <div class="call-stage">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
                <div id="voiceUI" style="position: absolute; inset: 0; background: #0a0a0f; display: none; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-meteor" style="font-size: 3rem; color: var(--accent); animation: pulse 2s infinite;"></i>
                    <h2 id="partnerName" style="margin-top: 20px;">Connected</h2>
                </div>
            </div>
            <div class="controls-hub">
                <button class="btn-ctrl" onclick="Logic.toggleMic()"><i id="mic-icon" class="fas fa-microphone"></i></button>
                <button class="btn-ctrl btn-hangup" onclick="Logic.endCall()"><i class="fas fa-phone-slash"></i></button>
                <button class="btn-ctrl" onclick="Logic.toggleVid()"><i id="vid-icon" class="fas fa-video"></i></button>
            </div>
        </div>
    </div>

    <div id="incoming-portal">
        <h1 class="logo" style="font-size: 3rem;">Incoming</h1>
        <h2 id="callerName" style="margin: 20px 0;">Someone</h2>
        <div style="display: flex; gap: 40px; margin-top: 40px;">
            <button class="btn-ctrl btn-hangup" onclick="Logic.rejectCall()"><i class="fas fa-times"></i></button>
            <button class="btn-ctrl" style="background: #00ff88;" onclick="Logic.acceptCall()"><i class="fas fa-check"></i></button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcNl780uBhUyOnU5tx_CYjssG3c6u6LfI",
            authDomain: "unknown-22d50.firebaseapp.com",
            databaseURL: "https://unknown-22d50-default-rtdb.firebaseio.com",
            projectId: "unknown-22d50",
            appId: "1:980627173755:web:be5d28e5dfebe05ed8cdde"
        };

        // Initialize Firebase immediately
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- 2. LOGIC ENGINE ---
        const Logic = {
            pc: null,
            localStream: null,
            iceServers: [{ urls: "stun:stun1.l.google.com:19302" }],
            myName: "",
            currentPartnerId: null,

            // Initialize App
            async init() {
                this.createStars();
                this.fetchTURN(); // Background task
            },

            async fetchTURN() {
                try {
                    const res = await fetch("https://broraa.metered.live/api/v1/turn/credentials?apiKey=2e46f1e771a5efc73bb510b59755185e301e");
                    this.iceServers = await res.json();
                    console.log("ðŸš€ International Lines Ready");
                } catch (e) { console.warn("Using STUN fallback"); }
            },

            // Navigation
            show(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.getElementById('incoming-portal').style.display = 'none';
            },

            // AUTHENTICATION (The "Continue" Fix)
            async handleJoin() {
                const btn = document.getElementById('joinBtn');
                const name = document.getElementById('nameInput').value.trim();
                const debug = document.getElementById('debug-info');
                
                if (!name) return alert("Enter your name, beloved soul. â¤ï¸");
                this.myName = name;
                
                btn.disabled = true;
                btn.innerText = "Connecting...";
                debug.innerText = "Reaching the stars...";

                try {
                    // Critical: Try to sign in. If it fails, the error will pop up.
                    const cred = await auth.signInAnonymously();
                    console.log("Auth Success:", cred.user.uid);
                    
                    // On success, Firebase Auth Observer (below) will trigger the dashboard
                } catch (err) {
                    btn.disabled = false;
                    btn.innerText = "Open Portal";
                    debug.innerText = "Error: " + err.message;
                    alert("STUCK? Ensure 'Anonymous Auth' is enabled in Firebase Console! Error: " + err.message);
                }
            },

            // Presence & Listeners
            startPresence(uid) {
                const ref = db.ref(`status/${uid}`);
                ref.set({ name: this.myName, online: true });
                ref.onDisconnect().remove();

                // Listen for users
                db.ref('status').on('value', snap => {
                    const list = document.getElementById('userList');
                    list.innerHTML = '';
                    let count = 0;
                    snap.forEach(child => {
                        if (child.key === uid) return;
                        count++;
                        const u = child.val();
                        const el = document.createElement('div');
                        el.className = 'user-node';
                        el.innerHTML = `
                            <div style="display:flex; align-items:center; gap:15px">
                                <div class="avatar-ring">${u.name[0]}</div>
                                <b>${u.name}</b>
                            </div>
                            <div class="call-actions">
                                <button class="btn-action" onclick="Logic.startCall('${child.key}', false, '${u.name}')"><i class="fas fa-phone"></i></button>
                                <button class="btn-action" style="background:rgba(255,45,117,0.2); color:var(--accent)" onclick="Logic.startCall('${child.key}', true, '${u.name}')"><i class="fas fa-video"></i></button>
                            </div>
                        `;
                        list.appendChild(el);
                    });
                    document.getElementById('userCount').innerText = count;
                });

                // Listen for Incoming Signals
                db.ref(`calls/${uid}`).on('value', snap => {
                    const data = snap.val();
                    if (data && data.offer && !this.currentPartnerId) {
                        this.currentPartnerId = data.callerId;
                        document.getElementById('callerName').innerText = data.callerName;
                        document.getElementById('incoming-portal').style.display = 'flex';
                    } else if (!data && this.pc) {
                        this.cleanup();
                    }
                });
            },

            // WEBRTC SIGNALING
            async startCall(targetId, isVideo, partnerName) {
                this.currentPartnerId = targetId;
                document.getElementById('partnerName').innerText = partnerName;
                await this.setupMedia(isVideo);
                this.show('screen-call');

                this.pc = new RTCPeerConnection({ iceServers: this.iceServers });
                this.localStream.getTracks().forEach(t => this.pc.addTrack(t, this.localStream));

                this.pc.onicecandidate = e => {
                    if (e.candidate) db.ref(`calls/${targetId}/callerCandidates`).push(e.candidate.toJSON());
                };

                this.pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };

                const offer = await this.pc.createOffer();
                await this.pc.setLocalDescription(offer);

                await db.ref(`calls/${targetId}`).set({
                    offer: { type: offer.type, sdp: offer.sdp },
                    callerName: this.myName,
                    callerId: auth.currentUser.uid,
                    isVideo: isVideo
                });

                db.ref(`calls/${targetId}/answer`).on('value', async snap => {
                    if (snap.val() && !this.pc.currentRemoteDescription) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
                    }
                });

                db.ref(`calls/${targetId}/calleeCandidates`).on('child_added', snap => {
                    this.pc.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
            },

            async acceptCall() {
                const uid = auth.currentUser.uid;
                const snap = await db.ref(`calls/${uid}`).get();
                const data = snap.val();
                
                await this.setupMedia(data.isVideo);
                this.show('screen-call');

                this.pc = new RTCPeerConnection({ iceServers: this.iceServers });
                this.localStream.getTracks().forEach(t => this.pc.addTrack(t, this.localStream));

                this.pc.onicecandidate = e => {
                    if (e.candidate) db.ref(`calls/${uid}/calleeCandidates`).push(e.candidate.toJSON());
                };

                this.pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };

                await this.pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await this.pc.createAnswer();
                await this.pc.setLocalDescription(answer);

                await db.ref(`calls/${uid}/answer`).set({ type: answer.type, sdp: answer.sdp });

                db.ref(`calls/${uid}/callerCandidates`).on('child_added', snap => {
                    this.pc.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
            },

            async setupMedia(video) {
                this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: video });
                document.getElementById('localVideo').srcObject = this.localStream;
                document.getElementById('localVideo').style.display = video ? 'block' : 'none';
                document.getElementById('voiceUI').style.display = video ? 'none' : 'flex';
            },

            endCall() {
                const uid = auth.currentUser.uid;
                db.ref(`calls/${this.currentPartnerId}`).remove();
                db.ref(`calls/${uid}`).remove();
                this.cleanup();
            },

            rejectCall() {
                db.ref(`calls/${auth.currentUser.uid}`).remove();
                document.getElementById('incoming-portal').style.display = 'none';
            },

            cleanup() {
                if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());
                if (this.pc) this.pc.close();
                this.pc = null;
                this.currentPartnerId = null;
                this.show('screen-dash');
            },

            // Toggles
            toggleMic() {
                const t = this.localStream.getAudioTracks()[0];
                t.enabled = !t.enabled;
                document.getElementById('mic-icon').className = t.enabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
            },
            toggleVid() {
                const t = this.localStream.getVideoTracks()[0];
                if(t) {
                    t.enabled = !t.enabled;
                    document.getElementById('vid-icon').className = t.enabled ? 'fas fa-video' : 'fas fa-video-slash';
                }
            },

            // Visuals
            createStars() {
                const nebula = document.getElementById('nebula');
                for(let i=0; i<80; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    const s = Math.random() * 3;
                    star.style.width = star.style.height = s + 'px';
                    star.style.setProperty('--d', (Math.random() * 3 + 2) + 's');
                    nebula.appendChild(star);
                }
            }
        };

        // --- 3. EXECUTION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("Authenticated User:", user.uid);
                Logic.startPresence(user.uid);
                Logic.show('screen-dash');
            }
        });

        Logic.init();

    </script>
</body>
</html>
